#!/usr/bin/python

import sys
import os
import optparse
import tempfile
import hashlib
import base64
import subprocess
import time

import pyfscache

class hash_set:
    def __init__(self):
        self.data = ''

    def do_hash(self, s):
        h = hashlib.md5()
        h.update(s)
        return base64.b64encode(h.digest())

    def hash_key(self, key, value):
        self.data = self.data + self.do_hash(key + '=' + self.do_hash(value))

    def hash_argv(self, argv):
        h = ''.join(map(self.do_hash, argv))
        self.hash_key('argv', h)

    def hash_environment(self, option, opt, value, parser):
        # Separate missing and zero values
        if value in os.environ and os.environ[value]:
            hash_arg = value + '=' + self.do_hash(os.environ[value])
        else:
            hash_arg = value
        self.hash_key('env', hash_arg)

    def hash_file_contents(self, option, opt, value, parser):
        try:
            contents = open(value).read()
        except IOError as e:
            print "open: {} (errno={}): {}".format(value, e.errno, e.strerror)
            sys.exit(1)
        hash_arg = value + '=' + self.do_hash(contents)
        self.hash_key('file', hash_arg)

hs = hash_set()

parser = optparse.OptionParser()
parser.add_option('-e', '--environment', action='callback',
        callback=hs.hash_environment, type='str')
parser.add_option('-f', '--file-contents', action='callback',
        callback=hs.hash_file_contents, type='str')
parser.add_option('--cache-dir', dest='cache_dir',
        default=os.path.expanduser('~/.cmdcache/'))
parser.add_option('-v', '--verbose', action='store_true', dest='verbose')
(options, cmd_argv) = parser.parse_args()
if len(cmd_argv) == 0:
    parser.print_help()
    sys.exit(1)

hs.hash_argv(cmd_argv)

inp = sys.stdin.read()
hs.hash_key('stdin', inp)

cache = pyfscache.FSCache(options.cache_dir, days=10)
if options.verbose == True:
    sys.stderr.write('Hash = {}\n'.format(hs.data))
try:
    result = cache[hs.data]
    if options.verbose == True:
        sys.stderr.write('Found in cache\n')
    sys.stdout.write(result)
except KeyError:
    tmp = tempfile.NamedTemporaryFile(delete=True)
    cmd_proc = subprocess.Popen(cmd_argv, stdout=tmp)
    cat_proc = subprocess.Popen(['/usr/bin/tail', '-f', tmp.name])

    with open(tmp.name) as f:
        cmd_proc.wait()
        output_data = f.read()
    # FIXME: pyfscache doesn't handle MT races
    cache[hs.data] = output_data
